# Connect to Content Type Hub
Connect-PnPOnline -Url "https://testspdomain.sharepoint.com/sites/parent1" -Interactive -ClientId "553a6b41-d10f-418b-be9d-4ba848607c04"

$templateFile = "C:\Scripts\FullTemplate.xml"
$filteredFile = "C:\Scripts\FilteredTemplate.xml"
$targetGroup = "Export4 Group"
$targetContentTypes = @("Export4 CT")

# Step 1: Export everything for Fields and ContentTypes
Get-PnPSiteTemplate -Out $templateFile -Handlers Fields, ContentTypes -Force

# Step 2: Load XML
[xml]$xml = Get-Content $templateFile

# Step 3: Keep only fields in target group
$fields = $xml.Provisioning.Templates.ProvisioningTemplate.SiteFields.Field
foreach ($field in $fields) {
    if ($field.Group -ne $targetGroup) {
        $field.ParentNode.RemoveChild($field) | Out-Null
    }
}

# Step 4: Keep only specified content types
$contentTypes = $xml.Provisioning.Templates.ProvisioningTemplate.ContentTypes.ContentType
foreach ($ct in $contentTypes) {
    if ($ct.Name -notin $targetContentTypes) {
        $ct.ParentNode.RemoveChild($ct) | Out-Null
    }
}

# Step 5: Save filtered file
$xml.Save($filteredFile)

Write-Host "Filtered template saved to $filteredFile"
